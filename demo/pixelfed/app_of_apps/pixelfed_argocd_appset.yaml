---
# third sync wave because it has to be up after postgres
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pixelfed-app-set
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  # enable go templating
  goTemplate: true
  # this generator allows us to values from an external k8s secret
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - pixelfed_hostname
              - pixelfed_s3_endpoint
              - global_cluster_issuer
              - global_time_zone
  template:
    metadata:
      name: pixelfed-web-app
      annotations:
        argocd.argoproj.io/sync-wave: "4"
        argocd.argoproj.io/sync-options: ApplyOnly=true
    spec:
      project: pixelfed

      # where the app is going
      destination:
        server: https://kubernetes.default.svc
        namespace: pixelfed

      # reconciliation policy
      syncPolicy:
        syncOptions:
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true

      # where the is coming from
      source:
        repoURL: https://small-hack.github.io/pixelfed-chart
        targetRevision: 0.2.1
        chart: pixelfed
        helm:
          releaseName: pixelfed
          valuesObject:
            fullnameOverride: pixelfed

            ingress:
              enabled: true
              className: nginx
              annotations:
                cert-manager.io/cluster-issuer: '{{ .global_cluster_issuer }}'
                nginx.ingress.kubernetes.io/proxy-body-size: 1g
              hosts:
                - host: '{{ .pixelfed_hostname }}'
                  paths:
                    - path: '/'
                      pathType: ImplementationSpecific
              tls:
                - secretName: pixelfed-tls
                  hosts:
                    - '{{ .pixelfed_hostname }}'

            # resource limits for pixelfed
            resources:
              limits:
                cpu: 1500m
                memory: 1Gi
              requests:
                cpu: 500m
                memory: 512Mi

            # for postgres ssl certs
            extraEnv:
              - name: "PGSSLCERT"
                value: /etc/secrets/pixelfed/tls.crt

              - name: "PGSSLKEY"
                value: /etc/secrets/pixelfed/tls.key

              - name: "PGSSLROOTCERT"
                value: /etc/secrets/ca/ca.crt

            # for postgres ssl certs
            extraVolumes:
              - name: postgres-ca
                secret:
                  secretName: pixelfed-postgres-server-ca-key-pair
                  defaultMode: 0640

              - name: postgres-client-certs
                secret:
                  secretName: pixelfed-postgres-pixelfed-cert
                  defaultMode: 0640

            # for postgres ssl certs
            extraVolumeMounts:
              - name: postgres-ca
                mountPath: /etc/secrets/ca

              - name: postgres-client-certs
                mountPath: /etc/secrets/pixelfed

            persistence:
              enabled: true
              existingClaim: "pixelfed"

            externalDatabase:
              enabled: true
              host: pixelfed-postgres-rw.pixelfed.svc
              port: "5432"
              database: pixelfed
              username: pixelfed
              existingSecret: "pixelfed-pgsql-credentials"
              existingSecretPasswordKey: postgresPassword
              tls_mode: "disable"
              sslcert: "/etc/secrets/pixelfed/tls.crt"
              sslkey: "/etc/secrets/pixelfed/tls.key"
              ca_cert: "/etc/secrets/ca/ca.crt"

            # https://github.com/bitnami/charts/tree/main/bitnami/postgresql#parameters
            postgresql:
              enabled: false

            pixelfed:
              # -- Automatically run [artisan migrate --force] if new migrations are detected.
              db_apply_new_migrations_automatically: false

              # -- timezone for docker container
              timezone: "europe/amsterdam"

              # -- Experimental Configuration
              exp_emc: true

              # -- domain of admin interface
              admin_domain: "{{ .pixelfed_hostname }}"

              # -- domain of session?
              session_domain: "{{ .pixelfed_hostname }}"

              # -- trusted proxies
              trusted_proxies: "*"

              # app specific settings
              app:
                # -- The name of your server/instance
                name: "Pixelfed"
                # -- change this to the domain of your pixelfed instance
                url: "https://{{ .pixelfed_hostname }}"
                # -- change this to the language code of your pixelfed instance
                locale: "en"
                # -- The domain of your server, without https://
                domain: "{{ .pixelfed_hostname }}"

              # -- Enable open registration for new accounts
              open_registration: false

              # -- Enforce email verification
              enforce_email_verification: true

              # -- The min password length
              min_password_length: 16

              # -- Enable account deletion (may be a requirement in some jurisdictions)
              account_deletion: true

              # -- Enable oAuth support, required for mobile/3rd party apps
              oauth_enabled: true

              # -- Enable the Stories feature
              stories_enabled: false

              # -- Enable the config cache to allow you to manage settings via the admin dashboard
              enable_config_cache: true

              # -- Set the image optimization quality, between 1-100. Lower uses less space, higher more quality
              image_quality: 80

              # -- The max allowed account size in KB
              max_account_size: 1000000

              # -- The max photo/video size in KB
              max_photo_size: 15000

              # -- The max user avatar size in KB
              max_avatar_size: 2000

              # -- The max post caption length
              max_caption_length: 1000

              # -- The max user bio length
              max_bio_length: 256

              # -- The max user display name length
              max_name_length: 32

              # -- The max number of media per post album
              max_album_length: 6

              # -- Force https url generation
              force_https_urls: true

              # your whole instance, or server, settings
              instance:
                # -- your server description
                description: "Pix Pizza Enby City - a place for meepmorps"
                # -- enable the instance contact form
                contact_form: true
                # -- Enable public access to the Discover feature
                discover_public: true
                # -- Allow anonymous access to hashtag feeds
                public_hashtags: true
                # -- The public contact email for your server
                contact_email: ""
                # -- Enable the profile embed feature
                profile_embeds: true
                # -- Enable the post embed feature
                post_embeds: true
                # -- Enable Curated Registration
                cur_reg: false
                # -- Enable the api/v1/peers API endpoint
                show_peers: false

                reports:
                  # -- Send a report email to the admin account for new autospam/reports
                  email_enabled: false
                  # -- A list of email addresses to deliver admin reports to
                  email_addresses: []
                  # -- Enable autospam reports (require INSTANCE_REPORTS_EMAIL_ENABLED)
                  email_autospam: false

                landing:
                  # -- Enable the profile directory on the landing page
                  show_directory: true
                  # -- Enable the popular post explore on the landing page
                  show_explore: true

              # public feed settings
              pf:
                # -- Hide sensitive posts from public/network feeds
                hide_nsfw_on_public_feeds: false
                # -- Store local avatars on S3 (Requires S3)
                local_avatar_to_cloud: false
                # -- Enable the Admin Invites feature
                admin_invites_enabled: true
                # -- The max number of user blocks per account
                max_user_blocks: 50
                # -- The max number of user mutes per account
                max_user_mutes: 50
                # -- The max number of domain blocks per account
                max_domain_blocks: 50
                # -- Enable S3/Object Storage
                enable_cloud: false
                # -- Limit max user registrations
                max_users: 1000
                # -- in KB
                enforce_max_users: 2000
                # -- Enable image optimization
                optimize_images: true
                # -- Enable video optimization
                optimize_videos: true
                # -- Max collection post limit
                max_collection_length: 100

              # ActivityPub Configuration
              activity_pub:
                enabled: true
                remote_follow: true
                inbox: true
                outbox: true
                sharedinbox: true

              ###########################################################
              # Federation
              ###########################################################
              # -- https://docs.pixelfed.org/technical-documentation/config/#atom_feeds
              atom_feeds: "true"

              # -- https://docs.pixelfed.org/technical-documentation/config/#nodeinfo
              nodeinfo: "true"

              # -- https://docs.pixelfed.org/technical-documentation/config/#webfinger
              webfinger: "true"

              mail:
                driver: smtp
                from_address: "no-reply@{{ .pixelfed_hostname }}"
                from_name: "Pixelfed"
                existingSecretName: "pixelfed-smtp-credentials"
                existingSecretKeys:
                  username: "username"
                  password: "password"
                  port: "port"
                  host: "host"

              s3:
               url: "https://{{ .pixelfed_s3_endpoint }}"
               endpoint: "{{ .pixelfed_s3_endpoint }}"
               # accessKey: ""
               # secretKey: ""
               # If this is set, accessKey, secretKey will not take place
               # Needs the S3_ACCESS_KEY_ID and S3_SECRET_ACCESS_KEY keys.
               existingSecret: "pixelfed-s3-credentials"
               bucket: "pixelfed"

            # -- https://github.com/pixelfed/pixelfed/blob/main/Dockerfile#L75
            # if you manually change the UID/GID environment variables, ensure these values match:
            podSecurityContext:
              runAsUser: 991
              runAsGroup: 991
              fsGroup: 991

            securityContext: {}

            serviceAccount:
              # -- Specifies whether a service account should be created
              create: true
              # -- Annotations to add to the service account
              annotations: {}

            # -- timezone for all the pods
            timezone: '{{ .global_time_zone }}'
