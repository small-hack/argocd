---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: ingress-nginx-helm-appset
  namespace: argocd
spec:
  goTemplate: true
  # generator allows us to source specific values from an external k8s secret
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - global_time_zone
  template:
    metadata:
      name: ingress-nginx-helm
    spec:
      project: ingress-nginx
      destination:
        server: 'https://kubernetes.default.svc'
        namespace: ingress-nginx
      syncPolicy:
        syncOptions:
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true
      source:
        repoURL: 'https://kubernetes.github.io/ingress-nginx'
        chart: ingress-nginx
        targetRevision: 4.10.1
        helm:
          releaseName: 'ingress-nginx'
          valuesObject:
            controller:
              # note: checkout controller.keda variables in the future
              replicaCount: 2
              configAnnotations:
                allow-snippet-annotations: "true"
                forwarded-for-header: X-Forwarded-For
                proxy-real-ip-cidr: 0.0.0.0/0
                real-ip-header: X-Real-IP
                use-forwarded-headers: "true"
              config:
                # always use 301 instead of a 308 redirect
                http-redirect-code: "301"
                # block all requests with no user-agent to kick out the annoying script kiddies
                block-user-agents: ""
                # show real ip in the logs
                enable-real-ip: "true"
                # restrict old versions of tls, could break old browsers/phones
                ssl-protocols: "TLSv1.3"
                # Enables Online Certificate Status Protocol stapling (OCSP) support.
                enable-ocsp: "true"
                # reject SSL handshake to an unknown virtualhost. helps to
                # mitigate the fingerprinting using default certificate of ingress
                ssl-reject-handshake: "true"
                # Enable Modsecurity and the OWASP Core rule set
                enable-modsecurity: "true"
                enable-owasp-modsecurity-crs: "true"

              # we set the timezone on the pod, to make logs easier to read
              extraEnvs:
                - name: TZ
                  value: '{{ .global_time_zone }}'

              # -- This configuration defines if Ingress Controller should allow users to set
              # their own *-snippet annotations, otherwise this is forbidden / dropped
              # when users add those annotations.
              # Global snippets in ConfigMap are still respected
              allowSnippetAnnotations: true

              resources:
                requests:
                  cpu: 100m
                  memory: 90Mi

              service:
                enabled: true
                type: LoadBalancer
                externalTrafficPolicy: 'Local'
                external:
                  enabled: true

              metrics:
                enabled: true
                serviceMonitor:
                  enabled: true
                prometheusRule:
                  enabled: false

