---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: debian12-cloud-vm
  namespace: argocd
spec:
  project: kubevirt
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
  ignoreDifferences:
    - kind: VirtualMachinePool
      name: scrapmetal
      jsonPointers:
      - /spec/replicas
  destination:
    namespace: kubevirt
    server: 'https://kubernetes.default.svc'
  source:
    repoURL: 'https://cloudymax.github.io/kubevirt-community-stack/'
    targetRevision: 0.3.6
    chart: kubevirt-vm
    helm:
      valuesObject:
        virtualMachine:
          name: scrapmetal
          namespace: kubevirt
          runStrategy: "RerunOnFailure"
          features:
            kvmEnabled: true
            acpiEnabled: true
            smmEnabled: false
            efiEnabled: false
            secureBoot: false
            autoattachPodInterface: true
            autoattachSerialConsole: true
            autoattachGraphicsDevice: true
            networkInterfaceMultiqueue: true

          machine:
            instancetype:
              name: standard-small
              kind: virtualMachineClusterInstancetype
            machineType: "q35"
            cpuPassthrough: true
            #vCores: 4
            pinCores: false
            hyperThreadingEnabled: false
            #memory: 8Gi
          #gpus: []
          #- name: gpu0
          #  deviceName: nvidia.com/GRID_RTX6000-4Q
          interfaces:
          - bridge: {}
            name: default
          networks:
          - name: default
            pod: {}

        virtualMachinePool:
          enabled: true
          replicas: 1
          hpa:
            enabled: false
            maxReplicas: 5
            minReplicas: 1

        diskErrorPolicy: "report"
        disks:
          - name: harddrive
            type: disk
            bus: virtio
            bootorder: 2
            readonly: false
            pvc: debian12
            ephemeral: true
          - name: cloudinitvolume
            type: cdrom
            bus: sata
            readonly: true
            bootorder: 1
            pv-enable: false

        service:
          - name: scrapmetal-service
            type: LoadBalancer
            ports:
              - name: ssh
                port: 22
                targetPort: 22
                protocol: TCP
              - name: vnc
                port: 5900
                targetPort: 5900
                protocol: TCP
              - name: rdp
                port: 3389
                protocol: TCP
                targetPort: 3389
              - name: sunshine0
                port: 47984
                protocol: TCP
                targetPort: 47984
              - name: sunshine1
                port: 47985
                protocol: TCP
                targetPort: 47985
              - name: sunshine2
                port: 47986
                protocol: TCP
                targetPort: 47986
              - name: sunshine3
                port: 47987
                protocol: TCP
                targetPort: 47987
              - name: sunshine4
                port: 47988
                protocol: TCP
                targetPort: 47988
              - name: sunshine5
                port: 47989
                protocol: TCP
                targetPort: 47989
              - name: sunshine6
                port: 47990
                protocol: TCP
                targetPort: 47990
              - name: sunshine7
                port: 47998
                protocol: UDP
                targetPort: 47998
              - name: sunshine8
                port: 47999
                protocol: UDP
                targetPort: 47999
              - name: sunshine9
                port: 48000
                protocol: UDP
                targetPort: 48000
              - name: sunshine10
                port: 48010
                protocol: TCP
                targetPort: 48010

        cloudinit:
          enabled: true
          secretName: friend-scrapmetal-user-data

        # -- set tieming and port number for liveness probe
        # livenessProbe:
        #   initialDelaySeconds: 120
        #   periodSeconds: 20
        #   tcpSocket:
        #     port: 1500
        #   timeoutSeconds: 10

        # -- set tieming and port number for readiness probe
        #readinessProbe:
        #  initialDelaySeconds: 120
        #  periodSeconds: 20
        #  timeoutSeconds: 10
        #  failureThreshold: 3
        #  successThreshold: 3
        #  httpGet:
        #    port: 1500
