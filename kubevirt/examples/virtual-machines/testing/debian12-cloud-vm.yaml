---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: debian12-cloud-vm
  namespace: argocd
spec:
  project: kubevirt
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  destination:
    namespace: kubevirt
    server: 'https://kubernetes.default.svc'
  source:
    repoURL: 'https://cloudymax.github.io/kubevirt-community-stack/'
    targetRevision: 0.3.1
    chart: kubevirt-vm
    helm:
      values: |
        virtualMachine:
          name: scrapmetal
          namespace: kubevirt
          runStrategy: "RerunOnFailure"
          features:
            kvmEnabled: true
            acpiEnabled: true
            smmEnabled: true
            efiEnabled: false
            autoattachPodInterface: true
            autoattachSerialConsole: true
            autoattachGraphicsDevice: true
          machine:
            machineType: "q35"
            cpuPassthrough: false
            vCores: 4
            pinCores: false
            hyperThreadingEnabled: false
            memory: 8Gi
          gpus:
          - name: gpu0
            deviceName: nvidia.com/GRID_RTX6000-4Q

        virtualMachinePool:
          enabled: false
          maxReplicas: 5
          minReplicas: 1

        disks:
          - name: harddrive
            type: disk
            bus: virtio
            bootorder: 2
            readonly: false
            pvsize: 40G
            pvstorageClassName: raid
            nodePlacement: scremlin
            pvaccessMode: ReadWriteOnce
            source: pvc
            pvcnamespace: kubevirt
            pvcname: debian12
          - name: cloudinitvolume
            type: cdrom
            bus: sata
            readonly: true
            bootorder: 1
            pv-enable: false

        service:
          - name: vm0-service
            type: LoadBalancer
            externalTrafficPolicy: Cluster
            ports:
              - name: ssh
                port: 22
                targetPort: 22
                protocol: TCP
              - name: vnc
                port: 5900
                targetPort: 5900
                protocol: TCP
              - name: status
                port: 1500
                targetPort: 1500
                protocol: TCP
              - name: https
                port: 443
                targetPort: 443
                protocol: TCP

        cloudinit:
          enabled: true
          secretName: friend-scrapmetal-user-data

        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 5
          tcpSocket:
            port: 1500
          timeoutSeconds: 60

        readinessProbe:
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 60
          failureThreshold: 100
          successThreshold: 3
          httpGet:
            port: 1500


