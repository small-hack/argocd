apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: capi-operator
  namespace: argocd
spec:
  destination:
    namespace: capi
    server: https://kubernetes.default.svc
  project: kubevirt
  source:
    path: charts/capi-operator
    repoURL: https://github.com/cloudymax/kubevirt-community-stack
    targetRevision: "0.4.7"
    helm:
      releaseName: capi-operator
      valuesObject:
        core: "cluster-api:v1.7.2"
        bootstrap: "kubeadm:v1.7.2"
        controlPlane: "kubeadm:v1.7.2"
        infrastructure: "kubevirt:v0.1.8"
        addon: ""
        manager:
          featureGates:
            kubeadm:
              MachinePool: true
              KubeadmBootstrapFormatIgnition: true
            core:
              MachinePool: true
              KubeadmBootstrapFormatIgnition: true
            kubevirt:
              MachinePool: true
              KubeadmBootstrapFormatIgnition: true
            bootstrap:
              MachinePool: true
              KubeadmBootstrapFormatIgnition: true

        configSecret: {}
        replicaCount: 1
        image:
          manager:
            repository: registry.k8s.io/capi-operator/cluster-api-operator
            tag: v0.15.0
            pullPolicy: IfNotPresent
        env:
          manager: []
        imagePullSecrets: {}
        args:
          - --v=2
          - --health-addr="0.0.0.0:8080"
          - --diagnostics-address="0.0.0.0:8443"
          - --insecure-diagnostics=true
          - --watch-configsecret
          - --leader-elect=true
        resources:
          manager:
            limits:
              cpu: 100m
              memory: 150Mi
            requests:
              cpu: 100m
              memory: 100Mi
        containerSecurityContext: {}
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: kubernetes.io/arch
                      operator: In
                      values:
                        - amd64
                        - arm64
                        - ppc64le
                    - key: kubernetes.io/os
                      operator: In
                      values:
                        - linux
        tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/master
          - effect: NoSchedule
            key: node-role.kubernetes.io/control-plane
        volumes:
          - name: cert
            secret:
              defaultMode: 420
              secretName: capi-operator-webhook-service-cert
        volumeMounts:
          manager:
            - mountPath: /tmp/k8s-webhook-server/serving-certs
              name: cert
              readOnly: true
               watchConfigSecret: false
  syncPolicy:
    syncOptions:
    - CreateNamespace=true
    - ApplyOutOfSyncOnly=true
