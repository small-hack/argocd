---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud-valkey-cluster-app
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: nextcloud
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
    automated:
      prune: true
      selfHeal: true
  source:
    repoURL: 'registry-1.docker.io'
    chart: bitnamicharts/valkey-cluster
    targetRevision: 0.1.2
    helm:
      values: |
        fullnameOverride: "valkey"

        usePassword: true
        password: ""
        existingSecret: "valkey-credentials"
        existingSecretPasswordKey: "valkey_password"

        tls:
          enabled: true
          authClients: true
          autoGenerated: true

        service:
          ports:
            valkey: 6379
          type: ClusterIP
          loadBalancerIP: ""
          loadBalancerSourceRanges: []
          externalTrafficPolicy: Cluster

        persistence:
          enabled: true
          path: /bitnami/valkey/data
          storageClass: "local-path"
          annotations:
            k8up.io/backup: "true"
          accessModes:
            - ReadWriteOnce
          size: 8Gi

        persistentVolumeClaimRetentionPolicy:
          enabled: false
          whenScaled: Retain
          whenDeleted: Retain

        valkey:
          command: []
          args: []
          updateStrategy:
            type: RollingUpdate
            rollingUpdate:
              partition: 0
          podManagementPolicy: Parallel
          automountServiceAccountToken: false
          hostNetwork: false
          useAOFPersistence: "yes"
          containerPorts:
            valkey: 6379
            bus: 16379
          resourcesPreset: "nano"
          resources: {}

        cluster:
          init: true
          nodes: 6
          replicas: 1
          externalAccess:
            enabled: false
            hostMode: false
            service:
              disableLoadBalancerIP: false
              type: LoadBalancer
              port: 6379
              loadBalancerIP: []
              loadBalancerSourceRanges: []

        metrics:
          enabled: false
          resourcesPreset: "nano"
          serviceMonitor:
            enabled: false
