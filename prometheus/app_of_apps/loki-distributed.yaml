apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-distributed-app
  namespace: argocd
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: monitoring
  source:
    repoURL: 'https://grafana.github.io/helm-charts'
    chart: loki-distributed
    targetRevision: 0.79.3
    helm:
      version: v3
      skipCrds: true
      valuesObject:
        fullnameOverride: loki

        loki:
          structuredConfig:
            memberlist:
              bind_addr: []

          revisionHistoryLimit: 2

          existingSecretForConfig: "loki-config"

          auth_enabled: false

        serviceAccount:
          create: true

        compactor:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          serviceAccount:
            create: true
          shared_store: s3
          resources:
            requests:
              cpu: 1
              memory: 2048Mi
            limits:
              cpu: 2
              memory: 4096Mi

          autoscaling:
            enabled: false
            minReplicas: 1
            maxReplicas: 4
            targetCPUUtilizationPercentage: 60
            targetMemoryUtilizationPercentage: 70
            customMetrics: []
            behavior:
              enabled: false
              scaleDown: {}
              scaleUp: {}

        gateway:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        memcachedchunks:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        memcachedfrontend:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        distributor:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        ingester:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        querier:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        queryFrontend:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        queryScheduler:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        ruler:
          enabled: false
          kind: Deployment
          replicas: 1
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)
          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          extraVolumeMounts:
            - name: fake
              mountPath: /etc/loki/rules/fake
          extraVolumes:
            - name: fake
              configMap:
                name: loki-cluster-rules
          resources: {}
          terminationGracePeriodSeconds: 300
          maxUnavailable: null
          nodeSelector: {}
          persistence:
            enabled: true
            size: 10Gi
            storageClass: local-path
          appProtocol:
            grpc: ""

  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
      - Retry=true
    automated:
      selfHeal: true
      prune: true
